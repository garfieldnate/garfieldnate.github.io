<!DOCTYPE html>
<html lang="en" class="astro-JTZ5WLZV">
    <head>
        <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- Primary Meta Tags -->
<title>Managing Global State: the Flip-Flop Operator</title>
<meta name="title" content="Managing Global State: the Flip-Flop Operator">
<meta name="description" content=".. creates hidden global state 😱">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.nateglenn.com/blog/posts/2013-02-03-managing-global-state-flip-flop-operator/">
<meta property="og:title" content="Managing Global State: the Flip-Flop Operator">
<meta property="og:description" content=".. creates hidden global state 😱">
<meta property="og:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting.jpg">
<meta property="og:image:alt" content="Japanese text with words highlighted for studying">
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.nateglenn.com/blog/posts/2013-02-03-managing-global-state-flip-flop-operator/">
<meta property="twitter:title" content="Managing Global State: the Flip-Flop Operator">
<meta property="twitter:description" content=".. creates hidden global state 😱">
<meta property="twitter:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting_2x1.jpg">
<meta property="twitter:image:alt" content="Japanese text with words highlighted for studying">

<!-- Fonts -->
<!-- Load google fonts in as performant a way as possible -->
<!-- (see https://web.dev/defer-non-critical-css/) -->

<!-- preconnect to location of google fonts' .woff files -->
<link rel="preconnect" href="https://fonts.gstatic.com">

<!-- request stylesheet asynchronously, update the element to a normal stylesheet when the resources are loaded -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">

<!-- fallback for browsers that don't execute JS -->
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap"></noscript>

    <link rel="stylesheet" href="/assets/index.eebc25cd.css" />
<link rel="stylesheet" href="/assets/2014-08-08-schools-kill-creativity.ed24385d.css" /><script type="module">const{classList:e}=document.documentElement,A=e.add.bind(e);A("jpeg");A("png");const g=(B,d)=>{const a=new Image;a.src=`data:image/${B};base64,${d}`,a.onload=A(B)};g("webp","UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==");g("avif","AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=");
</script></head>

    <body class="astro-JTZ5WLZV">
        <header class="wrapper astro-YMTJZWO2">
    <nav class="astro-YMTJZWO2">
        <a href="/" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Home</span>
        </a>
        <a href="/#portfolio" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Portfolio</span>
        </a>
        <a href="/resume/resume-en.html" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Resume</span>
        </a>
        <a href="/blog" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Blog</span>
        </a>
        <a href="https://www.linkedin.com/in/nathanglenn" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">LinkedIn</span>
        </a>
        <a href="https://github.com/garfieldnate/" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">GitHub</span>
        </a>
    </nav>
</header>


        <article class="wrapper content astro-JTZ5WLZV">
            <header class="astro-JTZ5WLZV">
                
                <h1 class="title astro-JTZ5WLZV">Managing Global State: the Flip-Flop Operator</h1>
                <!-- Machine readable datetime attribute, human-readable text --><time datetime="2013-02-03">3 Feb 2013</time>
            </header>
            <main class="astro-JTZ5WLZV">
                <p>Today I was faced with another mysterious failing test while writing a test suite for some legacy code. I knew it had to be a problem with persisting state because this particular test only failed when processing a particular data set with the same object which was just used to process another set.</p>
<p>My first step to trying to fix this was to delete all of the values stored in the object during the processing procedure:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#79C0FF">delete</span><span style="color:#C9D1D9"> $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">stateDatum1</span><span style="color:#C9D1D9">};</span></span>
<span class="line"><span style="color:#79C0FF">delete</span><span style="color:#C9D1D9"> $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">stateDatum2</span><span style="color:#C9D1D9">};</span></span>
<span class="line"><span style="color:#8B949E">#etc....</span></span></code></pre>
<p>Nothing changed. I reduced the problematic code into a small example for this post. First, the module to be tested:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#FF7B72">package</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">Demo::Bad::GlobalFlipFlop</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> strict;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> warnings;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> autodie;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> 5.010;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72">sub</span><span style="color:#C9D1D9"> </span><span style="color:#D2A8FF">new</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> ($class) = @_;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $self = {};</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">bless</span><span style="color:#C9D1D9"> $self, $class;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">return</span><span style="color:#C9D1D9"> $self;</span></span>
<span class="line"><span style="color:#C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E">#return true if parsing succeeded, false otherwise.</span></span>
<span class="line"><span style="color:#FF7B72">sub</span><span style="color:#C9D1D9"> </span><span style="color:#D2A8FF">parse</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> ($self, $file) = @_;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">open</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $file_in, </span><span style="color:#A5D6FF">&#39;&lt;&#39;</span><span style="color:#C9D1D9">, $file;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $started = 0;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">while</span><span style="color:#C9D1D9">( &lt;$file_in&gt; ){</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#8B949E">#flip-flop</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#FF7B72">next</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">unless</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">/^=startHere/</span><span style="color:#FF7B72">i</span><span style="color:#C9D1D9"> .. 0;    </span><span style="color:#8B949E"># start processing</span></span>
<span class="line"><span style="color:#C9D1D9">  $started = 1;</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#8B949E">#continue doing something with file contents...</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#8B949E"># say &#39;hello:)&#39; if(/hello/);</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#8B949E"># say &#39;goodbye:(&#39; if(/goodbye/);</span></span>
<span class="line"><span style="color:#C9D1D9"> }</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">if</span><span style="color:#C9D1D9">(</span><span style="color:#FF7B72">not</span><span style="color:#C9D1D9"> $started){</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#79C0FF">say</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;File not processed; missing &#39;=startHere&#39; line.&quot;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#C9D1D9">  </span><span style="color:#FF7B72">return</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#C9D1D9"> }</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">close</span><span style="color:#C9D1D9"> $file_in;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">return</span><span style="color:#C9D1D9"> 1;</span></span>
<span class="line"><span style="color:#C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9">1;</span></span></code></pre>
<p>The main idea here is that we are processing some file and returning a boolean representing its validity. The only requirement of validity of the file is that a certain start token is found within it; everything before the start sequence is ignored. Here are valid and invalid example files:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#c9d1d9">#good_file.txt</span></span>
<span class="line"><span style="color:#c9d1d9">=startHere</span></span>
<span class="line"><span style="color:#c9d1d9">hello</span></span>
<span class="line"><span style="color:#c9d1d9">goodbye</span></span>
<span class="line"><span style="color:#c9d1d9"></span></span>
<span class="line"><span style="color:#c9d1d9">#bad_file.txt- doesn&#39;t contain a start sequence</span></span>
<span class="line"><span style="color:#c9d1d9">hello</span></span>
<span class="line"><span style="color:#c9d1d9">goodbye</span></span></code></pre>
<p>Now, the test file:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> strict;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> warnings;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> autodie;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> Test::More </span><span style="color:#79C0FF">tests</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=&gt;</span><span style="color:#C9D1D9"> 2;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> File::Slurp;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> Demo::Bad::GlobalFlipFlop;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $good_name = </span><span style="color:#A5D6FF">&#39;good_file.txt&#39;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $bad_file = </span><span style="color:#A5D6FF">&#39;bad_file.txt&#39;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $demo = Demo::Bad::GlobalFlipFlop</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">new();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9">ok( $demo</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">parse($good_name) );</span></span>
<span class="line"><span style="color:#C9D1D9">ok( </span><span style="color:#FF7B72">not</span><span style="color:#C9D1D9"> $demo</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">parse($bad_file) );</span></span></code></pre>
<p>The output of running this file:</p>
<blockquote>
<p>perl test.pl
1..2
hello:)
goodbye:(
ok 1
hello:)
goodbye:(
not ok 2</p>
</blockquote>
<h1 id="failed-test-at-testpl-line-61">Failed test at test.pl line 61.</h1>
<h1 id="looks-like-you-failed-1-test-of-2">Looks like you failed 1 test of 2.</h1>
<p>Why did it fail the second test, which involves checking that an invalid file is considered invalid?</p>
<p>The bug is in the line which matches the start token:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#8B949E"># line 23</span></span>
<span class="line"><span style="color:#FF7B72">next</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">unless</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">/^=startHere/</span><span style="color:#FF7B72">i</span><span style="color:#C9D1D9"> .. 0; </span><span style="color:#8B949E"># start processing</span></span></code></pre>
<p>The regex, flip-flop operator and 0 were clearly some sort of idiom that I was unfamiliar with. I had only ever used the flip-flop with numbers, such as <code>1..10</code>, which iterates from numbers 1 through 10. How does it work? Let’s check <a href="http://perldoc.perl.org/perlop.html">perlop</a>:</p>
<blockquote>
<p>Each ”..” operator maintains its own boolean state, even across calls to a subroutine that contains it. It is false as long as its left operand is false. Once the left operand is true, the range operator stays true until the right operand is true <em>AFTER</em> which the range operator becomes false again.</p>
</blockquote>
<p>The mysterious line thus worked like this:</p>
<ul>
<li>Skip lines of the input file until the left side, a match for the start token, is true</li>
<li>Don’t skip lines again until the right side, <code>0</code>, is evaluated as true (which never happens).</li>
<li>The state of this flip-flop operator is stored between subsequent calls to the subroutine. It’s a hidden global variable! Usually flip-flop operators are used in contexts that are guaranteed a reset after iteration (such as <code>1..10</code>). Not so here! I replaced the offending code with some that keeps state for me:</li>
</ul>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $started = 0;</span></span>
<span class="line"><span style="color:#FF7B72">while</span><span style="color:#C9D1D9">(&lt;$file_in&gt;){</span></span>
<span class="line"><span style="color:#C9D1D9">    </span><span style="color:#FF7B72">if</span><span style="color:#C9D1D9">(</span><span style="color:#A5D6FF">/^=startHere/</span><span style="color:#FF7B72">i</span><span style="color:#C9D1D9">){</span></span>
<span class="line"><span style="color:#C9D1D9">        $started = 1;</span></span>
<span class="line"><span style="color:#C9D1D9">    }</span></span>
<span class="line"><span style="color:#C9D1D9">    </span><span style="color:#FF7B72">next</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">unless</span><span style="color:#C9D1D9"> $started;</span></span>
<span class="line"><span style="color:#8B949E">#continue processing...</span></span></code></pre>
<p>With this, everything works as expected:</p>
<blockquote>
<p>perl test.pl
1..2
ok 1
File not processed; missing ‘=startHere’ line.
ok 2</p>
</blockquote>
<p>Note that this bug only presented itself to me because I changed the legacy standalone script to be its own module, creating the possibility of storing state between subroutine calls.</p>
            </main>
        </article>
        <footer class="astro-Y3IBWMVA"><a href="/blog/rss.xml" class="astro-Y3IBWMVA"><img src="/rss/rss-icon.svg" height="15px" width="15px" alt="RSS logo" class="astro-Y3IBWMVA"> RSS</a>・<a href="/license" class="astro-Y3IBWMVA">License</a>・<a href="https://github.com/garfieldnate/garfieldnate.github.io" class="astro-Y3IBWMVA">Source</a></footer>


    
</body></html>