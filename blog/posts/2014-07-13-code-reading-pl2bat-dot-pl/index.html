<!DOCTYPE html>
<html lang="en" class="astro-BN6ECNDZ">
    <head>
        <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- Primary Meta Tags -->
<title>Code Reading: pl2bat.pl</title>
<meta name="title" content="Code Reading: pl2bat.pl">
<meta name="description" content="Looking under the hood of a ubiquitous tool">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.nateglenn.com/blog/posts/2014-07-13-code-reading-pl2bat-dot-pl/">
<meta property="og:title" content="Code Reading: pl2bat.pl">
<meta property="og:description" content="Looking under the hood of a ubiquitous tool">
<meta property="og:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting.jpg">
<meta property="og:image:alt" content="Japanese text with words highlighted for studying">
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.nateglenn.com/blog/posts/2014-07-13-code-reading-pl2bat-dot-pl/">
<meta property="twitter:title" content="Code Reading: pl2bat.pl">
<meta property="twitter:description" content="Looking under the hood of a ubiquitous tool">
<meta property="twitter:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting_2x1.jpg">
<meta property="twitter:image:alt" content="Japanese text with words highlighted for studying">

<!-- Fonts -->
<!-- Load google fonts in as performant a way as possible -->
<!-- (see https://web.dev/defer-non-critical-css/) -->

<!-- preconnect to location of google fonts' .woff files -->
<link rel="preconnect" href="https://fonts.gstatic.com">

<!-- request stylesheet asynchronously, update the element to a normal stylesheet when the resources are loaded -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">

<!-- fallback for browsers that don't execute JS -->
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap"></noscript>

    <link rel="stylesheet" href="/assets/index.b40cd55b.css" />
<link rel="stylesheet" href="/assets/2014-08-08-schools-kill-creativity.bb2b9901.css" /><script type="module">const{classList:e}=document.documentElement,A=e.add.bind(e);A("jpeg");A("png");const g=(B,d)=>{const a=new Image;a.src=`data:image/${B};base64,${d}`,a.onload=A(B)};g("webp","UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==");g("avif","AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=");
</script></head>

    <body class="astro-BN6ECNDZ">
        <header class="wrapper astro-RHTLMSAA">
    <nav class="astro-RHTLMSAA">
        
        <a href="/" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">Home</span>
        </a>
        <a href="/#portfolio" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">Portfolio</span>
        </a>
        <a href="/resume/resume-en.html" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">Resume</span>
        </a>
        <a href="/blog" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">Blog</span>
        </a>
        <a href="https://www.linkedin.com/in/nathanglenn" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">LinkedIn</span>
        </a>
        <a href="https://github.com/garfieldnate/" class="astro-RHTLMSAA">
            <span class="astro-RHTLMSAA">GitHub</span>
        </a>
    </nav>
</header>


        <article class="wrapper content astro-BN6ECNDZ">
            <header class="astro-BN6ECNDZ">
                
                <h1 class="title astro-BN6ECNDZ">Code Reading: pl2bat.pl</h1>
                <!-- Machine readable datetime attribute, human-readable text --><time datetime="2014-07-13">13 Jul 2014</time>
            </header>
            <main class="astro-BN6ECNDZ">
                <p>When you install a Perl distribution from CPAN that comes with an executable script, Perl adds it to your path so it can be treated like any other command line program. On a *nix system, all that needs to be done for this to work is to set the script to be executable. Windows doesn’t have executable script files with shebang lines like *nix, however, so Perl generates a batch file.</p>
<p>Let’s see how this works. First, let’s pick a distribution that comes with an executable script. The <code>App::</code> namespace is a great place to look for that.</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#c9d1d9">cpan App::Cleo</span></span>
<span class="line"><span style="color:#c9d1d9">...</span></span>
<span class="line"><span style="color:#c9d1d9">Running make install</span></span>
<span class="line"><span style="color:#c9d1d9">Installing C:\dev\strawberry-perl-5.18.2.2-64bit-portable\perl\site\lib\App\Cleo.pm</span></span>
<span class="line"><span style="color:#c9d1d9">Installing C:\dev\strawberry-perl-5.18.2.2-64bit-portable\perl\site\bin\cleo</span></span>
<span class="line"><span style="color:#c9d1d9">Installing C:\dev\strawberry-perl-5.18.2.2-64bit-portable\perl\site\bin\cleo.bat</span></span>
<span class="line"><span style="color:#c9d1d9">...</span></span></code></pre>
<p>Hmm, cleo.bat. That’s not in the <a href="https://metacpan.org/source/THALJEF/App-Cleo-0.004/bin">distribution</a>! Let’s take a look:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#c9d1d9">@rem = &#39;--*-Perl-*--</span></span>
<span class="line"><span style="color:#c9d1d9">@echo off</span></span>
<span class="line"><span style="color:#c9d1d9">if &quot;%OS%&quot; == &quot;Windows_NT&quot; goto WinNT</span></span>
<span class="line"><span style="color:#c9d1d9">IF EXIST &quot;%~dp0perl.exe&quot; (</span></span>
<span class="line"><span style="color:#c9d1d9">&quot;%~dp0perl.exe&quot; -x -S &quot;%0&quot; %1 %2 %3 %4 %5 %6 %7 %8 %9</span></span>
<span class="line"><span style="color:#c9d1d9">) ELSE IF EXIST &quot;%~dp0..\..\bin\perl.exe&quot; (</span></span>
<span class="line"><span style="color:#c9d1d9">&quot;%~dp0..\..\bin\perl.exe&quot; -x -S &quot;%0&quot; %1 %2 %3 %4 %5 %6 %7 %8 %9</span></span>
<span class="line"><span style="color:#c9d1d9">) ELSE (</span></span>
<span class="line"><span style="color:#c9d1d9">perl -x -S &quot;%0&quot; %1 %2 %3 %4 %5 %6 %7 %8 %9</span></span>
<span class="line"><span style="color:#c9d1d9">)</span></span>
<span class="line"><span style="color:#c9d1d9"></span></span>
<span class="line"><span style="color:#c9d1d9">...</span></span>
<span class="line"><span style="color:#c9d1d9"></span></span>
<span class="line"><span style="color:#c9d1d9">#!/usr/bin/env perl</span></span>
<span class="line"><span style="color:#c9d1d9">#line 29</span></span>
<span class="line"><span style="color:#c9d1d9"></span></span>
<span class="line"><span style="color:#c9d1d9">use strict;</span></span>
<span class="line"><span style="color:#c9d1d9">use warnings;</span></span>
<span class="line"><span style="color:#c9d1d9">use App::Cleo;</span></span>
<span class="line"><span style="color:#c9d1d9"></span></span>
<span class="line"><span style="color:#c9d1d9">our $VERSION = 0.003;</span></span>
<span class="line"><span style="color:#c9d1d9">...</span></span></code></pre>
<p>It seems to be a batch script with the entirety of cleo.pl pasted in the bottom. How does that work? Well first there’s a little bit of logic to differentiate requirements on Windows NT versus other Windows systems, and some logic to deal with Perl being located in different places (relative to <code>%~dp0</code>, the directory containing the script). <code>%0</code> is the name of the script being run, and Perl is being invoked on it with different arguments. The other %number arguments are the script arguments, which are passed along to the script once again. So this is a batch script that passes itself to Perl? But what’s Perl going to do with all of the batch garbage that comes before the actual Perl script?</p>
<p>The magic here is in the <code>-x</code> switch. From <a href="http://perldoc.perl.org/perlrun.html">perlrun</a>:</p>
<blockquote>
<p>tells Perl that the program is embedded in a larger chunk of unrelated text, such as in a mail message. Leading garbage will be discarded until the first line that starts with #! and contains the string “perl”. Any meaningful switches on that line will be applied.</p>
</blockquote>
<p>Ooh! That’s an interesting feature. I wonder if anyone still uses it for emailed scripts.</p>
<p>So the batch script calls Perl on itself, and Perl skips all of the batch syntax and goes straight to the shebang line (<code>#!/usr/bin/env perl</code>) and runs the original <a href="https://metacpan.org/source/THALJEF/App-Cleo-0.004/bin/cleo">cleo</a> Perl script.</p>
<p>The mechanism used to create this is is <a href="https://metacpan.org/pod/distribution/perl/win32/bin/pl2bat.pl">pl2bat.pl</a>, and you’ll find interesting history, motivation and gotchas in the documentation there. Thanks to pl2bat, CPAN author scripts are installed on Windows and added to the path. I can just open my cmd and type <code>cleo</code> to start the app.</p>
            </main>
        </article>
        <footer class="astro-Y3IBWMVA"><a href="/blog/rss.xml" class="astro-Y3IBWMVA"><img src="/rss/rss-icon.svg" height="15px" width="15px" alt="RSS logo" class="astro-Y3IBWMVA"> RSS</a>・<a href="/license" class="astro-Y3IBWMVA">License</a>・<a href="https://github.com/garfieldnate/garfieldnate.github.io" class="astro-Y3IBWMVA">Source</a></footer>


    
</body></html>