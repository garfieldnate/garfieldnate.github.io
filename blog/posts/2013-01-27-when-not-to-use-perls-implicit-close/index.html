<!DOCTYPE html>
<html lang="en" class="astro-JTZ5WLZV">
    <head>
        <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- Primary Meta Tags -->
<title>When not to use Perl&#39;s Implicit close</title>
<meta name="title" content="When not to use Perl's Implicit close">
<meta name="description" content="Suffering from Buffering">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.nateglenn.com/blog/posts/2013-01-27-when-not-to-use-perls-implicit-close/">
<meta property="og:title" content="When not to use Perl's Implicit close">
<meta property="og:description" content="Suffering from Buffering">
<meta property="og:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting.jpg">
<meta property="og:image:alt" content="Japanese text with words highlighted for studying">
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.nateglenn.com/blog/posts/2013-01-27-when-not-to-use-perls-implicit-close/">
<meta property="twitter:title" content="When not to use Perl's Implicit close">
<meta property="twitter:description" content="Suffering from Buffering">
<meta property="twitter:image" content="https://www.nateglenn.com/assets/portfolio/ja_segmenting_2x1.jpg">
<meta property="twitter:image:alt" content="Japanese text with words highlighted for studying">

<!-- Fonts -->
<!-- Load google fonts in as performant a way as possible -->
<!-- (see https://web.dev/defer-non-critical-css/) -->

<!-- preconnect to location of google fonts' .woff files -->
<link rel="preconnect" href="https://fonts.gstatic.com">

<!-- request stylesheet asynchronously, update the element to a normal stylesheet when the resources are loaded -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">

<!-- fallback for browsers that don't execute JS -->
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap"></noscript>

    <link rel="stylesheet" href="/assets/index.eebc25cd.css" />
<link rel="stylesheet" href="/assets/2014-08-08-schools-kill-creativity.ed24385d.css" /><script type="module">const{classList:e}=document.documentElement,A=e.add.bind(e);A("jpeg");A("png");const g=(B,d)=>{const a=new Image;a.src=`data:image/${B};base64,${d}`,a.onload=A(B)};g("webp","UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==");g("avif","AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=");
</script></head>

    <body class="astro-JTZ5WLZV">
        <header class="wrapper astro-YMTJZWO2">
    <nav class="astro-YMTJZWO2">
        <a href="/" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Home</span>
        </a>
        <a href="/#portfolio" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Portfolio</span>
        </a>
        <a href="/resume/resume-en.html" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Resume</span>
        </a>
        <a href="/blog" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">Blog</span>
        </a>
        <a href="https://www.linkedin.com/in/nathanglenn" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">LinkedIn</span>
        </a>
        <a href="https://github.com/garfieldnate/" class="astro-YMTJZWO2">
            <span class="astro-YMTJZWO2">GitHub</span>
        </a>
    </nav>
</header>


        <article class="wrapper content astro-JTZ5WLZV">
            <header class="astro-JTZ5WLZV">
                
                <h1 class="title astro-JTZ5WLZV">When not to use Perl&#39;s Implicit close</h1>
                <!-- Machine readable datetime attribute, human-readable text --><time datetime="2013-01-27">27 Jan 2013</time>
            </header>
            <main class="astro-JTZ5WLZV">
                <p>This post is a quick note on a bug I had difficulty tracking down.</p>
<p>One nice feature of Perl, introduced long before my time, is that of implicit closing. Perl closes filehandles for you when you forget (maybe on purpose). So the following is not a resource leak as a standalone script:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#79C0FF">open</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $file, </span><span style="color:#A5D6FF">&#39;&gt;utf8&#39;</span><span style="color:#C9D1D9">, </span><span style="color:#A5D6FF">&#39;/path/to/new/file&#39;</span></span>
<span class="line"><span style="color:#C9D1D9">    </span><span style="color:#FF7B72">or</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">die</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;couldn&#39;t open file: </span><span style="color:#C9D1D9">$!</span><span style="color:#A5D6FF">&quot;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#79C0FF">print</span><span style="color:#C9D1D9"> $file </span><span style="color:#A5D6FF">&#39;Hello!&#39;</span><span style="color:#C9D1D9">;</span></span></code></pre>
<p>When the script finishes, Perl will close $file for you, so you can be nice and lazy. The caveat to this is that the variable <code>$.</code> isn’t reset as it would be with a normal close (<a href="http://perldoc.perl.org/functions/close.html">see docs here</a>). <a href="http://www.perlmonks.org/?node_id=353259"><code>$.</code></a> holds the current line number from the last file read. So if you were processing a file line-by-line and found an error, you might print an error like <code>bad value foo on line XYZ</code> using the <code>$.</code> variable for <code>XYZ</code>. I raised a question about this on <a href="http://stackoverflow.com/questions/14513477/perl-implicit-close-resets#comment20233976_14513477">StackOverflow</a>.</p>
<p>Today I found another case where not explicitly closing a filehandle means trouble. I was working on testing a <a href="https://github.com/briandfoy/modulino-demo/blob/master/lib/Modulino/Demo.pm">modulino</a>-style script with flexible outputs. You can call a method to set the handle that this script prints to. In my test script, I was setting the handle to be some filehandle and then checking the contents of the file against a string. The problem? The file was always empty at run time, but contained what I expected it to when I manually inspected it. Here’s some example broken code:</p>
<pre class="astro-code" style="background-color:#0d1117;overflow-x:auto"><code><span class="line"><span style="color:#8B949E">#ImplicitClose.pm</span></span>
<span class="line"><span style="color:#FF7B72">package</span><span style="color:#C9D1D9"> </span><span style="color:#FFA657">Demo::Bad::ImplicitClose</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> strict;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> warnings;</span></span>
<span class="line"><span style="color:#FF7B72">sub</span><span style="color:#C9D1D9"> </span><span style="color:#D2A8FF">new</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> ($class) = @_;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $self = {};</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">bless</span><span style="color:#C9D1D9"> $self, $class;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">return</span><span style="color:#C9D1D9"> $self;</span></span>
<span class="line"><span style="color:#C9D1D9">}</span></span>
<span class="line"><span style="color:#FF7B72">sub</span><span style="color:#C9D1D9"> </span><span style="color:#D2A8FF">output_fh</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9">    </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> ( $self, $fh ) = @_;</span></span>
<span class="line"><span style="color:#C9D1D9">    </span><span style="color:#FF7B72">if</span><span style="color:#C9D1D9"> ($fh) {</span></span>
<span class="line"><span style="color:#C9D1D9">        </span><span style="color:#FF7B72">if</span><span style="color:#C9D1D9"> ( </span><span style="color:#79C0FF">ref</span><span style="color:#C9D1D9">($fh) </span><span style="color:#79C0FF">eq</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&#39;GLOB&#39;</span><span style="color:#C9D1D9"> ) {</span></span>
<span class="line"><span style="color:#C9D1D9">            $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">output_fh</span><span style="color:#C9D1D9">} = $fh;</span></span>
<span class="line"><span style="color:#C9D1D9">        }</span></span>
<span class="line"><span style="color:#C9D1D9">        </span><span style="color:#FF7B72">else</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9">            </span><span style="color:#79C0FF">open</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $fh2, </span><span style="color:#A5D6FF">&#39;&gt;&#39;</span><span style="color:#C9D1D9">, $fh </span><span style="color:#FF7B72">or</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">die</span><span style="color:#C9D1D9"> </span><span style="color:#A5D6FF">&quot;Couldn&#39;t open </span><span style="color:#C9D1D9">$fh</span><span style="color:#A5D6FF">&quot;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#C9D1D9">            $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">output_fh</span><span style="color:#C9D1D9">} = $fh2;</span></span>
<span class="line"><span style="color:#C9D1D9">        }</span></span>
<span class="line"><span style="color:#C9D1D9">    }</span></span>
<span class="line"><span style="color:#C9D1D9">    $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">output_fh</span><span style="color:#C9D1D9">};</span></span>
<span class="line"><span style="color:#C9D1D9">}</span></span>
<span class="line"><span style="color:#FF7B72">sub</span><span style="color:#C9D1D9"> </span><span style="color:#D2A8FF">some_long_method</span><span style="color:#C9D1D9"> {</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> ($self, $text) = @_;</span></span>
<span class="line"><span style="color:#C9D1D9"> </span><span style="color:#79C0FF">print</span><span style="color:#C9D1D9"> { $self</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">{</span><span style="color:#79C0FF">output_fh</span><span style="color:#C9D1D9">} } $text;</span></span>
<span class="line"><span style="color:#C9D1D9">}</span></span>
<span class="line"><span style="color:#C9D1D9">1;</span></span>
<span class="line"><span style="color:#8B949E">#test.pl</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> strict;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> warnings;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> autodie;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> Test::More </span><span style="color:#79C0FF">tests</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">=&gt;</span><span style="color:#C9D1D9"> 1;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> File::Slurp;</span></span>
<span class="line"><span style="color:#FF7B72">use</span><span style="color:#C9D1D9"> Demo::Bad::ImplicitClose;</span></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $file_name = </span><span style="color:#A5D6FF">&#39;file1.txt&#39;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#8B949E">#make sure we pass the test from outputting something *this* run</span></span>
<span class="line"><span style="color:#79C0FF">unlink</span><span style="color:#C9D1D9"> $file_name </span><span style="color:#FF7B72">if</span><span style="color:#C9D1D9"> </span><span style="color:#FF7B72">-e</span><span style="color:#C9D1D9"> $file_name;</span></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $print = </span><span style="color:#A5D6FF">&#39;some junk&#39;</span><span style="color:#C9D1D9">;</span></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $demo = Demo::Bad::ImplicitClose</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">new();</span></span>
<span class="line"><span style="color:#C9D1D9">$demo</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">output_fh($file_name);</span></span>
<span class="line"><span style="color:#C9D1D9">$demo</span><span style="color:#FF7B72">-&gt;</span><span style="color:#C9D1D9">some_long_method($print);</span></span>
<span class="line"><span style="color:#FF7B72">my</span><span style="color:#C9D1D9"> $contents = read_file($file_name);</span></span>
<span class="line"><span style="color:#C9D1D9">is($contents, $print);</span></span></code></pre>
<p>If you run <code>test.pl</code>, you’ll see that its one and only test fails:</p>
<blockquote>
<p>perl -I[folder where you put the Demo directory] test.pl
1..1
not ok 1</p>
</blockquote>
<h1 id="failed-test-at-testpl-line-68">Failed test at test.pl line 68.</h1>
<h1 id="got">got: ”</h1>
<h1 id="expected-some-junk">expected: ‘some junk’</h1>
<h1 id="looks-like-you-failed-1-test-of-1">Looks like you failed 1 test of 1.</h1>
<p>Then, when you inspect the contents of <code>file1.txt</code>, you have:</p>
<p>some junk</p>
<p>What happened here? I was <a href="http://perl.plover.com/FAQs/Buffering.html">suffering from buffering</a>. Because neither <code>test.pl</code> nor <code>ImplicitClose.pm</code> closed the file, it was still open when I was trying to read it. Nothing had been written to it yet because the amount printed was so small that it had to wait in the buffer either until there was more to write or until the file was closed, which would flush the buffer. Implicit close wouldn’t be performed until the the filehandle’s reference count reached 0, and the <code>$demo</code> object still had a reference to it. So the test would have worked fine if I had assigned <code>undef</code> to <code>$demo</code>, or just closed the filehandle.</p>
<p>Watch those implicit closes.</p>
            </main>
        </article>
        <footer class="astro-Y3IBWMVA"><a href="/blog/rss.xml" class="astro-Y3IBWMVA"><img src="/rss/rss-icon.svg" height="15px" width="15px" alt="RSS logo" class="astro-Y3IBWMVA"> RSS</a>・<a href="/license" class="astro-Y3IBWMVA">License</a>・<a href="https://github.com/garfieldnate/garfieldnate.github.io" class="astro-Y3IBWMVA">Source</a></footer>


    
</body></html>